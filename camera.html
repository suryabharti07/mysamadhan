<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pure HTML/CSS/JS Video Call (WebRTC, No Server)</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #161a22;
      --text: #eef2ff;
      --muted: #a3b1cf;
      --accent: #6aa6ff;
      --accent-2: #22c55e;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, #131826, transparent 60%), var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
    }

    header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 { font-size: 18px; margin: 0; font-weight: 700; letter-spacing: 0.2px; }
    header .sub { color: var(--muted); font-size: 13px; }

    main {
      padding: 0 16px 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 14px;
    }

    .videos {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .videos { grid-template-columns: 1fr 1fr; }
    }

    .video-wrap { position: relative; background: #000; border-radius: 14px; overflow: hidden; }
    video { width: 100%; height: 100%; display: block; aspect-ratio: 16/9; background: #000; }
    .badge {
      position: absolute; left: 10px; top: 10px; padding: 6px 10px; font-size: 12px; border-radius: 999px;
      background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.12);
    }

    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

    button, .btn {
      appearance: none; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04);
      color: var(--text); padding: 10px 14px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.24); }
    .primary { background: linear-gradient(180deg, var(--accent), #3b82f6); border-color: transparent; color: white; }
    .success { background: linear-gradient(180deg, var(--accent-2), #16a34a); border-color: transparent; color: white; }
    .danger { background: linear-gradient(180deg, var(--danger), #dc2626); border-color: transparent; color: white; }
    .ghost  { background: rgba(255,255,255,0.06); }

    textarea, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      background: rgba(0,0,0,0.35);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      outline: none;
      font-family: ui-monospace, Menlo, Consolas, Monaco, monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    textarea { min-height: 130px; resize: vertical; }

    label { font-size: 12px; color: var(--muted); display: block; margin: 8px 2px; }
    .small { font-size: 12px; color: var(--muted); }
    footer { text-align: center; padding: 12px; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üìπ WebRTC Video Call ‚Äî No Server</h1>
      <div class="sub">Everything runs in your browser with copy/paste signaling.</div>
    </div>
  </header>

  <main>
    <!-- Video Area -->
    <section class="panel videos">
      <div class="video-wrap">
        <video id="localVideo" autoplay playsinline muted></video>
        <span class="badge">You</span>
      </div>
      <div class="video-wrap">
        <video id="remoteVideo" autoplay playsinline></video>
        <span class="badge">Peer</span>
      </div>

      <div class="controls">
        <button id="btnStart" class="primary">Start Camera & Mic</button>
        <button id="btnToggleCam" class="ghost">Toggle Camera</button>
        <button id="btnToggleMic" class="ghost">Toggle Mic</button>
        <button id="btnShare" class="ghost">Share Screen</button>
        <button id="btnHangup" class="danger">Hang Up</button>
      </div>
      <div class="small">Tip: Open this page in two browsers/devices. One side uses the ‚ÄúCaller‚Äù flow, the other uses the ‚ÄúCallee‚Äù flow below.</div>
    </section>

    <!-- Signaling Panels -->
    <section class="grid-2">
      <!-- Caller -->
      <div class="panel">
        <h3>üëã Caller (Create Offer)</h3>
        <div class="controls">
          <button id="btnCreateOffer" class="success">Create Offer</button>
          <button id="btnCopyOffer" class="ghost">Copy Offer</button>
        </div>
        <label for="offerOut">Your Offer (send to peer)</label>
        <textarea id="offerOut" placeholder="Click Create Offer, then Copy & send"></textarea>

        <label for="answerIn">Peer Answer (paste here)</label>
        <textarea id="answerIn" placeholder="Paste the answer you received"></textarea>
        <div class="controls">
          <button id="btnApplyAnswer" class="primary">Apply Answer</button>
        </div>
      </div>

      <!-- Callee -->
      <div class="panel">
        <h3>üôå Callee (Answer Offer)</h3>
        <label for="offerIn">Peer Offer (paste here)</label>
        <textarea id="offerIn" placeholder="Paste the caller's offer"></textarea>
        <div class="controls">
          <button id="btnAcceptOffer" class="primary">Accept Offer</button>
          <button id="btnCreateAnswer" class="success">Create Answer</button>
          <button id="btnCopyAnswer" class="ghost">Copy Answer</button>
        </div>
        <label for="answerOut">Your Answer (send back)</label>
        <textarea id="answerOut" placeholder="Click Create Answer, then Copy & send"></textarea>
      </div>
    </section>
  </main>

  <footer>
    Built with WebRTC (STUN only). To avoid copy/paste, add your own WebSocket signaling later.
  </footer>

  <script>
    // --- Elements
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    const btnStart = document.getElementById('btnStart');
    const btnToggleCam = document.getElementById('btnToggleCam');
    const btnToggleMic = document.getElementById('btnToggleMic');
    const btnShare = document.getElementById('btnShare');
    const btnHangup = document.getElementById('btnHangup');

    const btnCreateOffer = document.getElementById('btnCreateOffer');
    const btnCopyOffer = document.getElementById('btnCopyOffer');
    const btnApplyAnswer = document.getElementById('btnApplyAnswer');

    const btnAcceptOffer = document.getElementById('btnAcceptOffer');
    const btnCreateAnswer = document.getElementById('btnCreateAnswer');
    const btnCopyAnswer = document.getElementById('btnCopyAnswer');

    const offerOut = document.getElementById('offerOut');
    const answerIn = document.getElementById('answerIn');

    const offerIn = document.getElementById('offerIn');
    const answerOut = document.getElementById('answerOut');

    // --- State
    let pc = null;            // RTCPeerConnection
    let localStream = null;   // MediaStream from camera/mic
    let screenTrack = null;   // Optional screen share track

    // Use public STUN so peers behind NAT can discover candidates.
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // Utility: clipboard copy
    async function copy(el) {
      try {
        await navigator.clipboard.writeText(el.value.trim());
        el.select();
      } catch (e) {
        // Fallback if clipboard blocked
        el.select();
        document.execCommand('copy');
      }
    }

    function ensurePC() {
      if (pc) return pc;
      pc = new RTCPeerConnection(rtcConfig);

      // Remote tracks
      pc.ontrack = (ev) => {
        // Get the first stream for remote video
        if (!remoteVideo.srcObject) {
          remoteVideo.srcObject = ev.streams[0];
        }
      };

      // Helpful logging
      pc.oniceconnectionstatechange = () => {
        console.log('ICE state:', pc.iceConnectionState);
      };
      pc.onconnectionstatechange = () => {
        console.log('PC state:', pc.connectionState);
      };

      return pc;
    }

    async function startLocal() {
      if (localStream) return localStream;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        if (!pc) ensurePC();
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        return localStream;
      } catch (err) {
        alert('Failed to access camera/mic: ' + err.message);
        throw err;
      }
    }

    function stopAll() {
      if (screenTrack) {
        screenTrack.stop();
        screenTrack = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      if (pc) {
        try { pc.getSenders().forEach(s => pc.removeTrack(s)); } catch {}
        pc.ontrack = null;
        pc.close();
        pc = null;
      }
      remoteVideo.srcObject = null;
      localVideo.srcObject = null;
      offerOut.value = answerOut.value = offerIn.value = answerIn.value = '';
    }

    // Wait until ICE gathering completes so the SDP blob is self-contained (no trickle copy needed)
    function waitForIceGatheringComplete(pc) {
      return new Promise(resolve => {
        if (pc.iceGatheringState === 'complete') {
          resolve();
        } else {
          function check() {
            if (pc.iceGatheringState === 'complete') {
              pc.removeEventListener('icegatheringstatechange', check);
              resolve();
            }
          }
          pc.addEventListener('icegatheringstatechange', check);
          // Also set a 2.5s timeout as a fallback to not hang forever on some networks
          setTimeout(() => resolve(), 2500);
        }
      });
    }

    // --- Event wiring
    btnStart.addEventListener('click', startLocal);

    btnToggleCam.addEventListener('click', () => {
      if (!localStream) return;
      const v = localStream.getVideoTracks()[0];
      if (v) { v.enabled = !v.enabled; }
      btnToggleCam.textContent = (v && v.enabled) ? 'Turn Camera Off' : 'Turn Camera On';
    });

    btnToggleMic.addEventListener('click', () => {
      if (!localStream) return;
      const a = localStream.getAudioTracks()[0];
      if (a) { a.enabled = !a.enabled; }
      btnToggleMic.textContent = (a && a.enabled) ? 'Mute Mic' : 'Unmute Mic';
    });

    btnShare.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const track = stream.getVideoTracks()[0];
        screenTrack = track;
        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender) sender.replaceTrack(track);
        track.onended = () => {
          // Restore camera when user stops sharing
          if (localStream) {
            const cam = localStream.getVideoTracks()[0];
            if (cam && sender) sender.replaceTrack(cam);
          }
          screenTrack = null;
        };
      } catch (e) {
        console.log('Screen share cancelled/failed:', e);
      }
    });

    btnHangup.addEventListener('click', stopAll);

    // --- Caller flow
    btnCreateOffer.addEventListener('click', async () => {
      await startLocal();
      const pcx = ensurePC();
      const offer = await pcx.createOffer({ offerToReceiveVideo: true, offerToReceiveAudio: true });
      await pcx.setLocalDescription(offer);
      await waitForIceGatheringComplete(pcx);
      offerOut.value = JSON.stringify(pcx.localDescription);
    });

    btnCopyOffer.addEventListener('click', () => copy(offerOut));

    btnApplyAnswer.addEventListener('click', async () => {
      try {
        const answer = JSON.parse(answerIn.value.trim());
        await ensurePC().setRemoteDescription(answer);
        answerIn.value = '';
      } catch (e) {
        alert('Invalid answer JSON');
      }
    });

    // --- Callee flow
    btnAcceptOffer.addEventListener('click', async () => {
      try {
        await startLocal();
        const pcx = ensurePC();
        const offerDesc = JSON.parse(offerIn.value.trim());
        await pcx.setRemoteDescription(offerDesc);
      } catch (e) {
        alert('Invalid offer JSON');
      }
    });

    btnCreateAnswer.addEventListener('click', async () => {
      const pcx = ensurePC();
      const answer = await pcx.createAnswer();
      await pcx.setLocalDescription(answer);
      await waitForIceGatheringComplete(pcx);
      answerOut.value = JSON.stringify(pcx.localDescription);
    });

    btnCopyAnswer.addEventListener('click', () => copy(answerOut));

    // Small UX niceties
    window.addEventListener('beforeunload', () => stopAll());
  </script>
</body>
</html>
