<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNA VIDYALAYA</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom CSS for YouTube-like dark theme and responsive layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #ffffff; /* White text */
            /* Ensure smooth scrolling for anchors */
            scroll-behavior: smooth;
        }

        /* Video container for 16:9 aspect ratio */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background-color: #000;
            border-radius: 0.5rem; /* Rounded corners for the player */
        }
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem; /* Match container border-radius */
        }

        /* Custom scrollbar styling for video lists */
        .video-list-scroll {
            max-height: calc(100vh - 8rem); /* Adjust based on header/footer height */
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #4a4a4a #2a2a2a; /* Firefox */
        }
        .video-list-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .video-list-scroll::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 10px;
        }
        .video-list-scroll::-webkit-scrollbar-thumb {
            background-color: #4a4a4a;
            border-radius: 10px;
            border: 2px solid #2a2a2a;
        }

        /* Style for video cards on home page */
        .video-card {
            background-color: #2a2a2a;
            border-radius: 0.75rem; /* More rounded corners */
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow */
        }
        .video-card:hover {
            transform: translateY(-8px); /* More pronounced lift */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4); /* Deeper shadow on hover */
        }
        .video-card img {
            width: 100%;
            height: 180px; /* Fixed height for thumbnails */
            object-fit: cover;
            border-radius: 0.75rem 0.75rem 0 0; /* Rounded top corners */
        }
        .video-card-info {
            padding: 1rem;
        }
        .video-card-title {
            font-weight: 600;
            font-size: 1.1rem; /* Slightly larger title */
            line-height: 1.4;
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #e0e0e0; /* Lighter white for titles */
        }
        .video-card-meta {
            font-size: 0.85rem; /* Slightly larger meta text */
            color: #9ca3af;
        }

        /* Styles for search suggestions */
        .search-suggestions {
            position: absolute;
            background-color: #2a2a2a;
            border-radius: 0.5rem;
            max-height: 250px; /* Slightly taller */
            overflow-y: auto;
            z-index: 10;
            width: 100%;
            left: 0;
            right: 0;
            top: calc(100% + 0.5rem);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5); /* Enhanced shadow */
            border: 1px solid #333;
        }
        .suggestion-item {
            padding: 0.85rem 1.25rem; /* More padding */
            cursor: pointer;
            color: #ffffff;
            transition: background-color 0.2s ease-in-out;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background-color: #4a4a4a;
            font-weight: 500;
        }

        /* Filter button styles */
        .filter-button {
            padding: 0.6rem 1.2rem; /* More padding */
            border-radius: 9999px;
            background-color: #333333;
            color: #ffffff;
            font-size: 0.9rem; /* Slightly larger font */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Subtle shadow */
        }
        .filter-button:hover {
            background-color: #4a4a4a;
            transform: translateY(-2px); /* Slight lift on hover */
        }
        .filter-button.active {
            background-color: #666666;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Deeper shadow for active state */
        }

        /* Image Modal Styles */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(8px); /* More blur */
            animation: fadeIn 0.3s ease-out; /* Fade in animation */
        }
        .image-modal-content {
            position: relative;
            max-width: 95%; /* Larger modal content */
            max-height: 95%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.75rem; /* More rounded */
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); /* Stronger shadow */
        }
        .image-modal-close {
            position: absolute;
            top: 1.5rem; /* Further from edge */
            right: 1.5rem;
            background-color: rgba(255, 255, 255, 0.3); /* Lighter background */
            color: #ffffff;
            border-radius: 50%;
            width: 3rem; /* Larger close button */
            height: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem; /* Larger icon */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .image-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1); /* Slight scale on hover */
        }

        /* Channel Logo Styles */
        .channel-logo {
            width: 2.2rem; /* Slightly larger */
            height: 2.2rem;
            border-radius: 50%;
            background-color: #ff0000; /* Red background for AV */
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem; /* Slightly larger font */
            color: #ffffff;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Subtle shadow */
        }
        .channel-name {
            font-size: 0.95rem; /* Slightly larger */
            color: #aaaaaa;
            margin-left: 0.6rem; /* More spacing */
        }

        /* Custom styles for the progress bar and volume slider thumb */
        .progress-bar-fill {
            background-color: #ff0000; /* YouTube Red */
        }
        .volume-slider::-webkit-slider-thumb,
        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; /* Larger thumb */
            height: 18px;
            border-radius: 50%;
            background: #ff0000; /* YouTube Red */
            cursor: pointer;
            box-shadow: 0 0 0 5px rgba(255, 0, 0, 0.3); /* Larger glow */
            transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .volume-slider::-moz-range-thumb,
        .progress-bar::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff0000;
            cursor: pointer;
            box-shadow: 0 0 0 5px rgba(255, 0, 0, 0.3);
            transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .volume-slider::-webkit-slider-thumb:hover,
        .progress-bar::-webkit-slider-thumb:hover {
            background: #e60000; /* Darker red on hover */
            box-shadow: 0 0 0 6px rgba(255, 0, 0, 0.5); /* More pronounced glow */
        }
        .volume-slider::-moz-range-thumb:hover,
        .progress-bar::-moz-range-thumb:hover {
            background: #e60000;
            box-shadow: 0 0 0 6px rgba(255, 0, 0, 0.5);
        }

        /* Hide default video controls */
        video::-webkit-media-controls {
            display: none !important;
        }
        video::-webkit-media-controls-enclosure {
            display: none !important;
        }

        /* Custom scrollbar for gallery */
        #mediaGallery::-webkit-scrollbar,
        #videoGallery::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        #mediaGallery::-webkit-scrollbar-track,
        #videoGallery::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 10px;
        }
        #mediaGallery::-webkit-scrollbar-thumb,
        #videoGallery::-webkit-scrollbar-thumb {
            background: #606060;
            border-radius: 10px;
        }
        #mediaGallery::-webkit-scrollbar-thumb:hover,
        #videoGallery::-webkit-scrollbar-thumb:hover {
            background: #808080;
        }

        /* Custom styles for the range input track fill */
        input[type="range"]::-webkit-slider-runnable-track {
            background: transparent;
        }
        input[type="range"]::-moz-range-track {
            background: transparent;
        }
        input[type="range"]:focus {
            outline: none;
        }

        /* Adjusting main content area for fixed header */
        .main-content-area {
            margin-top: 68px; /* To account for fixed header height */
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideInFromBottom {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-900 text-gray-100 font-sans">
    <!-- Header Section -->
    <header class="w-full bg-gray-900 p-4 flex items-center justify-between shadow-lg z-30 fixed top-0 left-0 right-0 border-b border-gray-800 animate-slideInFromTop">
        <div class="flex items-center space-x-2 sm:space-x-4 ml-2">
            <!-- YouTube Logo with multicolor, acting as home link -->
            <div class="flex items-center space-x-1 cursor-pointer transform hover:scale-105 transition-transform duration-200" id="homeLink">
                <span class="text-3xl font-bold bg-gradient-to-r from-red-500 via-purple-600 to-blue-500 bg-clip-text text-transparent">
                    <i class="fab fa-youtube"></i>
                </span>
                <span class="text-xl sm:text-2xl font-bold text-white hidden sm:block">APNA VIDYALAYA</span>
            </div>
        </div>

        <div class="flex-grow w-full mx-2 sm:mx-4 flex items-center max-w-2xl"> <!-- Added max-w-2xl for search bar width -->
            <div class="relative flex-grow">
                <input type="text" id="searchInput" placeholder="Search videos and images..."
                       class="w-full p-2.5 pl-5 pr-12 rounded-full bg-gray-800 text-white border border-gray-700 focus:outline-none focus:border-red-600 shadow-inner transition-all duration-200">
                <button class="absolute right-0 top-0 h-full w-12 sm:w-16 bg-gray-700 rounded-r-full flex items-center justify-center border border-gray-700 hover:bg-gray-600 transition-colors duration-200">
                    <i class="fas fa-search text-lg sm:text-xl text-gray-300"></i>
                </button>
                <div id="searchResultsContainer" class="search-suggestions hidden">
                    <!-- Search suggestions will be injected here -->
                </div>
            </div>
        </div>
        <div class="flex items-center space-x-4 mr-2">
            <!-- User/Profile Icon (Placeholder) -->
            <i class="fas fa-user-circle text-2xl text-gray-300 cursor-pointer hover:text-white transition-colors duration-200"></i>
        </div>
    </header>

    <main class="flex-grow main-content-area py-8">
        <!-- Home Page Section -->
        <section id="homePage" class="container mx-auto p-4">
            <h2 class="text-3xl font-bold mb-6 text-white animate-fadeIn">Recommended Videos</h2>
            <!-- Filter Buttons -->
            <div id="filterButtons" class="flex flex-wrap gap-3 mb-8 animate-fadeIn">
                <button class="filter-button active" data-filter="all">All</button>
                <button class="filter-button" data-filter="today">Today</button>
                <button class="filter-button" data-filter="thisWeek">This Week</button>
                <button class="filter-button" data-filter="thisMonth">This Month</button>
            </div>
            <div id="homeVideoGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- Video cards and image cards will be injected here by JavaScript -->
                <p id="homeLoadingMessage" class="col-span-full text-center text-gray-500">Loading media...</p>
            </div>
        </section>

        <!-- Video Player Page Section -->
        <section id="videoPlayerPage" class="hidden flex-col lg:flex-row flex-grow w-full p-4 gap-6">
            <!-- Main Media Player Section (Left/Top) -->
            <section class="lg:w-3/4 w-full bg-gray-900 rounded-xl shadow-2xl overflow-hidden animate-fadeIn">
                <div class="relative group aspect-video" id="mainMediaPlayerContainer">
                    <!-- Added crossorigin="anonymous" for CORS compliance -->
                    <video id="mainVideoPlayer" class="w-full h-full rounded-t-xl bg-black" src="" poster="" preload="auto" crossorigin="anonymous"></video>
                    <img id="imagePlayer" class="w-full h-full object-contain rounded-t-xl bg-black hidden" src="" alt="Selected Image">

                    <!-- Loading Spinner Overlay -->
                    <div id="loadingSpinner" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 z-20 hidden backdrop-blur-sm">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-600"></div>
                    </div>

                    <!-- Play/Pause overlay button (Video-specific) -->
                    <div id="playOverlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 opacity-100 transition-opacity duration-300 group-hover:opacity-100 cursor-pointer hidden">
                        <button class="text-white text-6xl opacity-75 hover:opacity-100 transition-opacity duration-200">
                            <i class="fas fa-play-circle"></i>
                        </button>
                    </div>

                    <!-- Custom Controls (Video-specific) -->
                    <div id="controls" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4 opacity-0 transition-opacity duration-300 group-hover:opacity-100 flex flex-col space-y-2 hidden">
                        <!-- Progress Bar -->
                        <div class="relative w-full h-2 bg-gray-600 rounded-full cursor-pointer" id="progressBarContainer">
                            <div class="absolute h-full bg-red-600 rounded-full" id="progressBarFill" style="width: 0%;"></div>
                            <input type="range" id="progressBar" value="0" min="0" max="100" class="absolute w-full h-full appearance-none bg-transparent cursor-pointer top-0 left-0 z-10">
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- Play/Pause Button -->
                                <button id="playPauseBtn" class="text-white text-2xl hover:text-red-400 transition-colors">
                                    <i class="fas fa-play"></i>
                                </button>

                                <!-- Volume Control -->
                                <div class="flex items-center space-x-2">
                                    <button id="muteBtn" class="text-white text-xl hover:text-red-400 transition-colors">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" class="volume-slider w-20 h-1 bg-gray-600 rounded-full appearance-none cursor-pointer">
                                </div>

                                <!-- Time Display -->
                                <div class="text-gray-300 text-sm">
                                    <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
                                </div>
                            </div>

                            <!-- Fullscreen Button -->
                            <button id="fullscreenBtn" class="text-white text-2xl hover:text-red-400 transition-colors">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <h2 id="videoTitle" class="text-xl md:text-3xl font-bold mb-2 text-white"></h2>
                    <p id="videoDescription" class="text-gray-400 text-sm md:text-base mb-4"></p>
                    <div class="flex items-center mt-4 text-gray-500 text-sm">
                        <span id="videoViewsCount" class="mr-2">0 views</span>
                        <span class="mx-1">•</span>
                        <span id="videoUploadDate"></span>
                    </div>
                    <div class="flex items-center mt-4 space-x-4 border-t border-gray-700 pt-4">
                        <button id="likeButton" class="text-gray-400 hover:text-red-500 transition-colors duration-200 flex items-center px-3 py-1 rounded-full bg-gray-800 hover:bg-gray-700">
                            <svg class="w-6 h-6 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                            <span id="videoLikesCount">0</span>
                        </button>
                        <button id="shareButton" class="text-gray-400 hover:text-white transition-colors duration-200 flex items-center px-3 py-1 rounded-full bg-gray-800 hover:bg-gray-700">
                            <svg class="w-6 h-6 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.977l-1.471 1.47A3.001 3.001 0 0010 10a3.001 3.001 0 00-1.526-.447l-1.471-1.47A3 3 0 102 12h.01a.75.75 0 000-1.5H2a1.5 1.5 0 011.06-2.56l1.47-1.47A3 3 0 005 5a1.5 1.5 0 012.56-1.06l1.47 1.47A3 3 0 0010 4a3 3 0 10-2.977 2.977l1.471 1.47A3.001 3.001 0 0010 10a3.001 3.001 0 001.526.447l1.471 1.47A3 3 0 1015 12h.01a.75.75 0 000-1.5H15a1.5 1.5 0 01-1.06-2.56l-1.47-1.47A3 3 0 0010 8z" clip-rule="evenodd" /></svg>
                            <span>Share</span>
                        </button>
                        <button id="downloadButton" class="text-gray-400 hover:text-white transition-colors duration-200 flex items-center px-3 py-1 rounded-full bg-gray-800 hover:bg-gray-700">
                            <svg class="w-6 h-6 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M.001 10.5a.5.5 0 01.5-.5h18.998a.5.5 0 01.5.5v.5a.5.5 0 01-.5.5H.501a.5.5 0 01-.5-.5v-.5zM10 16a.5.5 0 01-.354-.146l-4-4a.5.5 0 01.708-.708L9.5 14.293V3.5a.5.5 0 011 0v10.793l3.146-3.147a.5.5 0 01.708.708l-4 4A.5.5 0 0110 16z" clip-rule="evenodd" /></svg>
                            <span>Download</span>
                        </button>
                    </div>
                    <!-- Channel Info for Video Player -->
                    <div class="flex items-center mt-6 pt-4 border-t border-gray-700">
                        <div class="channel-logo">AV</div>
                        <span class="channel-name">APNA VIDYALAYA</span>
                    </div>
                </div>
            </section>

            <!-- Video List/Suggestions Section -->
            <aside class="lg:w-1/4 w-full bg-gray-900 rounded-xl shadow-2xl p-4 video-list-scroll animate-fadeIn">
                <h3 class="text-xl font-semibold mb-4 text-white">Up Next</h3>
                <div id="videoList" class="space-y-4">
                    <!-- Video items will be injected here by JavaScript -->
                    <p id="relatedLoadingMessage" class="col-span-full text-center text-gray-500">Loading related content...</p>
                </div>
            </aside>
        </section>
    </main>

    <footer class="bg-gray-800 p-4 text-center text-gray-400 text-sm shadow-inner mt-8 animate-slideInFromBottom">
        <p>&copy; 2025 APNA VIDYALAYA. All rights reserved.</p>
    </footer>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal-overlay hidden">
        <div class="image-modal-content">
            <img id="modalImage" src="" alt="Full size image">
            <span id="modalCloseButton" class="image-modal-close">&times;</span>
        </div>
    </div>

    <script>
        // Google Drive API Configuration
        // IMPORTANT: Replace FOLDER_ID and API_KEY with your actual Google Drive Folder ID and API Key.
        // If you are seeing "Error loading media...", it's likely due to incorrect configuration or permissions.

        // How to get a Google Drive API Key:
        // 1. Go to Google Cloud Console: https://console.cloud.google.com/
        // 2. Create a new project or select an existing one.
        // 3. Navigate to "APIs & Services" > "Credentials".
        // 4. Click "Create Credentials" > "API Key".
        // 5. Copy the generated API Key.
        // 6. Go to "APIs & Services" > "Enabled APIs & services".
        // 7. Search for and enable "Google Drive API".

        // How to make your Google Drive Folder and Files Publicly Accessible:
        // 1. In Google Drive, right-click on the folder you want to use.
        // 2. Select "Share".
        // 3. Under "General access", change "Restricted" to "Anyone with the link".
        // 4. Ensure the role is "Viewer".
        // 5. Copy the Folder ID from the URL (it's the string after /folders/ in the URL).
        //    Example URL: https://drive.google.com/drive/folders/YOUR_FOLDER_ID_HERE
        // 6. Make sure all files inside this folder are also publicly accessible. If you upload new files,
        //    you might need to adjust their sharing settings individually or ensure they inherit permissions.

        const FOLDER_ID = "1LXYRya4OETFcyjdPpoPE9_UR34C-JkYy"; // Replace with your actual folder ID
        const API_KEY = "AIzaSyBiJ001rSt1s-oYX7iG7sD_7JWP2xDzNK0"; // Replace with your actual API Key

        // Declare variables globally
        let allMediaFiles = []; // To store all fetched media for filtering

        let homePage, videoPlayerPage, homeLink, searchInput, searchResultsContainer, filterButtonsContainer;
        let mainVideoPlayer, imagePlayer, mainMediaPlayerContainer, loadingSpinner, playOverlay, controls;
        let playPauseBtn, progressBar, progressBarFill, volumeSlider, muteBtn, currentTimeSpan, durationSpan, fullscreenBtn;
        let videoTitle, videoDescription, videoViewsCount, videoUploadDate, likeButton, shareButton, downloadButton;
        let videoList, homeVideoGrid, homeLoadingMessage, relatedLoadingMessage;
        let imageModal, modalImage, modalCloseButton;

        let isDraggingProgressBar = false;
        let lastVolume = 1; // Store last volume before muting
        let controlsTimeout; // For hiding controls after inactivity
        let currentPlayingMediaId = null;
        let currentPlayingMediaUrl = null; // Store current media URL for download/share

        // Initialize likes and views from localStorage
        let videoLikes = JSON.parse(localStorage.getItem('videoLikes')) || {};
        let videoViews = JSON.parse(localStorage.getItem('videoViews')) || {};
        let deviceLikedVideos = JSON.parse(localStorage.getItem('deviceLikedVideos')) || {};


        // --- Utility Functions ---

        // Function to format time (e.g., 00:00)
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        // Helper function to format date as "X days/weeks/months/years ago"
        function formatDateAgo(dateString) {
            const uploadDate = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now.getTime() - uploadDate.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 1) {
                return "Today";
            } else if (diffDays === 1) {
                return "Yesterday";
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else if (diffDays < 30) {
                const diffWeeks = Math.floor(diffDays / 7);
                return `${diffWeeks} weeks ago`;
            } else if (diffDays < 365) {
                const diffMonths = Math.floor(diffDays / 30);
                return `${diffMonths} months ago`;
            } else {
                const diffYears = Math.floor(diffDays / 365);
                return `${diffYears} years ago`;
            }
        }

        // Function to save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('videoLikes', JSON.stringify(videoLikes));
            localStorage.setItem('videoViews', JSON.stringify(videoViews));
            localStorage.setItem('deviceLikedVideos', JSON.stringify(deviceLikedVideos));
        }

        // --- Page Navigation Functions ---

        // Function to show/hide pages
        function showPage(pageName) {
            homePage.classList.add('hidden');
            videoPlayerPage.classList.add('hidden');

            if (pageName === 'homePage') {
                homePage.classList.remove('hidden');
                // Reset player state when navigating away from player page
                mainVideoPlayer.pause();
                mainVideoPlayer.src = "";
                mainVideoPlayer.load();
                // When returning to home, set a generic poster and clear title
                mainVideoPlayer.poster = "https://placehold.co/1280x720/1a1a1a/ffffff?text=Select+a+video";
                imagePlayer.src = ""; // Clear image source
                imagePlayer.classList.add('hidden'); // Ensure image player is hidden
                mainVideoPlayer.classList.remove('hidden'); // Ensure video player is visible (with poster)

                videoTitle.textContent = "Select media from gallery";
                videoDescription.textContent = ""; // Clear description
                videoUploadDate.textContent = "No date";
                videoViewsCount.textContent = "0 views";
                videoLikesCount.textContent = "0";

                // Hide video controls
                controls.classList.add('hidden');
                playOverlay.classList.add('hidden');
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                progressBar.value = 0;
                progressBarFill.style.width = '0%';

                renderHomePageVideos(); // Reload media for the homepage
            } else if (pageName === 'videoPlayerPage') {
                videoPlayerPage.classList.remove('hidden');
                videoPlayerPage.classList.add('flex'); // Ensure flex display for player layout
            }
        }

        // --- Main Media Player Functions ---

        // Toggle Play/Pause for the main player (Video-specific)
        function togglePlayPause() {
            if (imagePlayer.classList.contains('hidden')) { // Only act if video player is visible
                if (!mainVideoPlayer.src) {
                    return; // Do nothing if no video source is set
                }
                if (mainVideoPlayer.paused || mainVideoPlayer.ended) {
                    mainVideoPlayer.play();
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; // Set to pause icon immediately on play
                    playOverlay.style.opacity = '0'; // Hide overlay on play
                } else {
                    mainVideoPlayer.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playOverlay.style.opacity = '1'; // Show overlay on pause
                }
            }
        }

        // Update volume icon based on current volume level (Video-specific)
        function updateVolumeIcon() {
            if (mainVideoPlayer.volume === 0) {
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else if (mainVideoPlayer.volume < 0.5) {
                muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
            } else {
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
        }

        // Function to load a video/image into the main player and switch to player page
        function loadMedia(mediaItem) {
            showPage('videoPlayerPage'); // Always go to player page

            // Reset player area state
            loadingSpinner.classList.remove('hidden'); // Show spinner initially
            mainVideoPlayer.pause(); // Always pause any playing video
            mainVideoPlayer.src = ""; // Clear video source
            mainVideoPlayer.load(); // Ensure video player state is reset
            imagePlayer.src = ""; // Clear image source

            // Hide video-specific controls by default
            controls.classList.add('hidden');
            playOverlay.classList.add('hidden'); // Hide play overlay for images
            // Hide all video controls initially
            playPauseBtn.classList.add('hidden');
            progressBarContainer.classList.add('hidden');
            volumeSlider.classList.add('hidden');
            muteBtn.classList.add('hidden');
            currentTimeSpan.classList.add('hidden');
            durationSpan.classList.add('hidden');
            fullscreenBtn.classList.add('hidden');


            currentPlayingMediaId = mediaItem.id;
            currentPlayingMediaUrl = `https://www.googleapis.com/drive/v3/files/${mediaItem.id}?alt=media&key=${API_KEY}`;

            console.log(`[loadMedia] Loading media: ${mediaItem.title}`);
            console.log(`[loadMedia] Media Type: ${mediaItem.type}`);
            console.log(`[loadMedia] Media URL: ${currentPlayingMediaUrl}`);


            if (mediaItem.type === 'video') {
                mainVideoPlayer.classList.remove('hidden');
                imagePlayer.classList.add('hidden');

                // Set video poster to its thumbnail while loading
                mainVideoPlayer.poster = mediaItem.thumbnail || 'https://placehold.co/1280x720/1a1a1a/ffffff?text=Loading+Video';

                // Show video-specific controls
                controls.classList.remove('hidden');
                playOverlay.classList.remove('hidden');
                playPauseBtn.classList.remove('hidden');
                progressBarContainer.classList.remove('hidden');
                volumeSlider.classList.remove('hidden');
                muteBtn.classList.remove('hidden');
                currentTimeSpan.classList.remove('hidden');
                durationSpan.classList.remove('hidden');
                fullscreenBtn.classList.remove('hidden');


                mainVideoPlayer.src = currentPlayingMediaUrl;
                mainVideoPlayer.load();
                mainVideoPlayer.play(); // Automatically play the video
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; // Set to pause icon immediately on play
                playOverlay.style.opacity = '0'; // Hide overlay when video starts playing
                videoTitle.textContent = mediaItem.title;
                videoDescription.textContent = mediaItem.description || ''; // Use description if available
                videoUploadDate.textContent = formatDateAgo(mediaItem.uploadDate);

                // Increment views
                videoViews[mediaItem.id] = (videoViews[mediaItem.id] || 0) + 1;
                saveToLocalStorage();
                videoViewsCount.textContent = `${videoViews[mediaItem.id]} views`;
                videoLikesCount.textContent = `${videoLikes[mediaItem.id]}`;

                // Update likes display and button state for the main player
                likeButton.dataset.mediaId = mediaItem.id; // Set data-media-id for the button
                if (deviceLikedVideos[mediaItem.id]) {
                    likeButton.classList.add('text-red-500');
                } else {
                    likeButton.classList.remove('text-red-500');
                }

                // Filter related videos: exclude current video, show only videos
                const relatedVideos = allMediaFiles.filter(m => m.id !== mediaItem.id && m.type === 'video');
                console.log(`[loadMedia] Rendering ${relatedVideos.length} related videos for ${mediaItem.title}`);
                renderMediaItems(relatedVideos, videoList, false);
            } else if (mediaItem.type === 'image') {
                mainVideoPlayer.classList.add('hidden');
                imagePlayer.classList.remove('hidden');

                imagePlayer.src = currentPlayingMediaUrl;
                loadingSpinner.classList.add('hidden'); // Images load faster, hide spinner
                videoTitle.textContent = mediaItem.title;
                videoDescription.textContent = mediaItem.description || ''; // Use description if available
                videoUploadDate.textContent = formatDateAgo(mediaItem.uploadDate);
                videoViewsCount.textContent = "N/A"; // Views not applicable for images
                videoLikesCount.textContent = "N/A"; // Likes not applicable for images

                // Update likes display and button state for the main player (for images, just reset)
                likeButton.dataset.mediaId = mediaItem.id; // Set data-media-id for the button
                likeButton.classList.remove('text-red-500'); // Images cannot be liked in this app

                // Filter related images: exclude current image, show only images
                const relatedImages = allMediaFiles.filter(m => m.id !== mediaItem.id && m.type === 'image');
                console.log(`[loadMedia] Rendering ${relatedImages.length} related images for ${mediaItem.title}`);
                renderMediaItems(relatedImages, videoList, false);
            }
            searchInput.value = ''; // Clear search input
            searchResultsContainer.classList.add('hidden'); // Hide suggestions
        }


        // Add like functionality
        function handleLikeClick(mediaId) {
            console.log(`[handleLikeClick] Like button clicked for mediaId: ${mediaId}`);
            if (mediaId && !deviceLikedVideos[mediaId]) { // Ensure mediaId is valid and not already liked
                videoLikes[mediaId] = (videoLikes[mediaId] || 0) + 1;
                deviceLikedVideos[mediaId] = true;
                saveToLocalStorage();
                // Update UI for the main player if it's the current media
                if (currentPlayingMediaId === mediaId) {
                    videoLikesCount.textContent = `${videoLikes[mediaId]}`;
                    likeButton.classList.add('text-red-500');
                }
                // Re-render home page videos to update like counts there too
                renderHomePageVideos(searchInput.value);
                console.log(`[handleLikeClick] Media ${mediaId} liked. New likes: ${videoLikes[mediaId]}`);
            } else if (mediaId && deviceLikedVideos[mediaId]) {
                console.log(`[handleLikeClick] Media ${mediaId} already liked on this device.`);
            } else {
                console.log('[handleLikeClick] No valid media selected to like.');
            }
        }

        // Share functionality
        async function handleShareClick() {
            if (currentPlayingMediaUrl) {
                const mediaTitleText = videoTitle.textContent;
                const shareData = {
                    title: mediaTitleText,
                    text: `Check out "${mediaTitleText}" on APNA VIDYALAYA!`,
                    url: window.location.href.split('?')[0] + '?media=' + currentPlayingMediaId, // A conceptual share link
                };

                // Use Web Share API if available
                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                        console.log('[handleShareClick] Media shared via Web Share API.');
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            console.log('[handleShareClick] Share operation cancelled.');
                        } else {
                            console.error('[handleShareClick] Error sharing:', err);
                        }
                    }
                } else {
                    // Fallback to copying URL to clipboard
                    const tempInput = document.createElement('textarea');
                    tempInput.value = shareData.url; // Use the shareable URL
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    try {
                        document.execCommand('copy');
                        console.log('[handleShareClick] Media link copied to clipboard.');
                    } catch (err) {
                        console.error('[handleShareClick] Failed to copy text:', err);
                    }
                    document.body.removeChild(tempInput);
                }
            } else {
                console.log('[handleShareClick] No media currently playing to share.');
            }
        }

        // Download functionality
        function handleDownloadClick() {
            if (currentPlayingMediaUrl) {
                const link = document.createElement('a');
                link.href = currentPlayingMediaUrl;
                // Sanitize title for filename, replacing non-alphanumeric with underscores
                link.download = videoTitle.textContent.replace(/[^a-z0-9\s]/gi, '').replace(/\s+/g, '_').toLowerCase() + (currentPlayingMediaUrl.includes('mimeType=video') ? '.mp4' : '.jpg'); // Guess extension
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('[handleDownloadClick] Download initiated.');
            } else {
                console.log('[handleDownloadClick] No media currently playing to download.');
            }
        }


        // Function to render media items in the gallery (for homepage and "Up Next" sidebar)
        function renderMediaItems(filesToRender, targetGalleryElement, isHomePage = true) {
            targetGalleryElement.innerHTML = ""; // Clear existing content
            console.log(`[renderMediaItems] Rendering ${filesToRender.length} items for ${isHomePage ? 'home page' : 'related content'}.`);

            if (filesToRender.length === 0) {
                targetGalleryElement.innerHTML = `<p class='col-span-full text-center text-gray-500'>${isHomePage ? 'No media found.' : 'No related content found.'}</p>`;
                return;
            }

            filesToRender.forEach(file => {
                const isVideo = file.type === 'video';
                const isImage = file.type === 'image';

                const displayDate = formatDateAgo(file.uploadDate);
                const thumbnailUrl = file.thumbnail || (isVideo ? 'https://placehold.co/320x180/4B5563/D1D5DB?text=Video' : 'https://placehold.co/320x180/4B5563/D1D5DB?text=Image');

                const mediaItem = document.createElement("div");
                mediaItem.className = isHomePage ? "video-card" : "flex items-start gap-3 cursor-pointer hover:bg-gray-700 p-2 rounded-lg transition-colors duration-200";

                if (isHomePage) {
                    const currentLikes = videoLikes[file.id] || 0;
                    const currentViews = videoViews[file.id] || 0;

                    mediaItem.innerHTML = `
                        <div class="relative w-full aspect-video">
                            <img src="${thumbnailUrl}" alt="${file.title}" class="w-full h-full object-cover rounded-t-lg" loading="lazy">
                            ${isVideo ? `<span class="absolute bottom-1 right-1 bg-black bg-opacity-75 text-white text-xs px-1 py-0.5 rounded">0:00</span>` : ''}
                            ${isImage ? `<i class="fas fa-image absolute top-2 left-2 text-white text-lg bg-black bg-opacity-50 p-1 rounded-md"></i>` : ''}
                        </div>
                        <div class="p-3">
                            <h4 class="video-card-title">${file.title}</h4>
                            <p class="video-card-meta">${isVideo ? `${currentViews} views` : 'N/A'} • ${displayDate}</p>
                            <div class="flex items-center mt-2">
                                <div class="channel-logo">AV</div>
                                <span class="channel-name">APNA VIDYALAYA</span>
                            </div>
                        </div>
                    `;
                } else { // For related content gallery
                    const currentLikes = videoLikes[file.id] || 0;
                    const currentViews = videoViews[file.id] || 0;

                    mediaItem.innerHTML = `
                        <div class="flex-shrink-0 w-40 h-24 rounded-lg overflow-hidden relative">
                            <img src="${thumbnailUrl}" alt="${file.title}" class="w-full h-full object-cover" loading="lazy">
                            ${isVideo ? `<span class="absolute bottom-1 right-1 bg-black bg-opacity-75 text-white text-xs px-1 py-0.5 rounded">0:00</span>` : ''}
                            ${isImage ? `<i class="fas fa-image absolute top-2 left-2 text-white text-lg bg-black bg-opacity-50 p-1 rounded-md"></i>` : ''}
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-semibold text-white line-clamp-2">${file.title}</h4>
                            <p class="text-xs text-gray-400">${isVideo ? `${currentViews} views` : 'N/A'} • ${displayDate}</p>
                            <div class="flex items-center mt-1">
                                <div class="channel-logo w-5 h-5 text-xs">AV</div>
                                <span class="channel-name text-xs">APNA VIDYALAYA</span>
                            </div>
                        </div>
                    `;
                }

                mediaItem.addEventListener('click', () => {
                    // If it's an image on the homepage, open the modal
                    if (isHomePage && isImage) {
                        modalImage.src = file.url;
                        imageModal.classList.remove('hidden');
                    } else {
                        // Otherwise, load media into the player
                        loadMedia(file);
                    }
                });
                targetGalleryElement.appendChild(mediaItem);
            });
        }


        // Function to filter media based on type and search term
        function getFilteredMedia(filterType, searchTerm = '') {
            console.log(`[getFilteredMedia] Applying filter: ${filterType}, search term: "${searchTerm}"`);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Start of today
            const sevenDaysAgo = new Date(now);
            sevenDaysAgo.setDate(now.getDate() - 7);
            const thirtyDaysAgo = new Date(now);
            thirtyDaysAgo.setDate(now.getDate() - 30);

            let filtered = allMediaFiles;

            // Apply search term first if present
            if (searchTerm) {
                filtered = filtered.filter(media =>
                    media.title.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Apply time-based filter
            if (filterType === 'today') {
                filtered = filtered.filter(media => {
                    const uploadDate = new Date(media.uploadDate);
                    return uploadDate.toDateString() === today.toDateString();
                });
            } else if (filterType === 'thisWeek') {
                filtered = filtered.filter(media => {
                    const uploadDate = new Date(media.uploadDate);
                    return uploadDate >= sevenDaysAgo;
                });
            } else if (filterType === 'thisMonth') {
                filtered = filtered.filter(media => {
                    const uploadDate = new Date(media.uploadDate);
                    return uploadDate >= thirtyDaysAgo;
                });
            }
            // 'all' filter doesn't require further filtering
            console.log(`[getFilteredMedia] Found ${filtered.length} items after filtering.`);
            return filtered;
        }

        // Function to render home page video grid with filters and images
        let currentFilter = 'all'; // Default filter

        function renderHomePageVideos(searchTerm = '') {
            console.log(`[renderHomePageVideos] Re-rendering home page with filter: ${currentFilter}, search term: "${searchTerm}"`);
            const filteredContent = getFilteredMedia(currentFilter, searchTerm);
            homeVideoGrid.innerHTML = ''; // Clear existing grid

            const homePageTitle = document.querySelector('#homePage h2');
            if (searchTerm) {
                homePageTitle.textContent = `Search results for "${searchTerm}"`;
            } else {
                homePageTitle.textContent = "Recommended Videos";
            }

            if (filteredContent.length === 0) {
                homeVideoGrid.innerHTML = '<p class="text-gray-400 text-center col-span-full">No videos or images found.</p>';
                return;
            }

            // Render combined content (videos and images)
            renderMediaItems(filteredContent, homeVideoGrid, true);
        }

        // Function to render search suggestions
        function renderSearchSuggestions(searchTerm) {
            searchResultsContainer.innerHTML = ''; // Clear previous suggestions
            if (searchTerm.length === 0) {
                searchResultsContainer.classList.add('hidden');
                return;
            }
            console.log(`[renderSearchSuggestions] Generating suggestions for "${searchTerm}"`);

            const filteredSuggestions = allMediaFiles.filter(media =>
                media.title.toLowerCase().includes(searchTerm.toLowerCase())
            ).slice(0, 5); // Limit to 5 suggestions

            if (filteredSuggestions.length > 0) {
                filteredSuggestions.forEach(media => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    // Add a search icon before the text
                    suggestionItem.innerHTML = `<i class="fas fa-search text-gray-400 mr-2"></i><span>${media.title}</span>`;
                    suggestionItem.addEventListener('click', () => {
                        const selectedTitle = media.title;
                        searchInput.value = selectedTitle; // Set search input to selected suggestion
                        searchResultsContainer.classList.add('hidden'); // Hide suggestions

                        // Instead of loading the single media, render the home page with this search term
                        showPage('homePage'); // Ensure we are on the home page
                        renderHomePageVideos(selectedTitle); // Filter home page by the selected suggestion
                    });
                    searchResultsContainer.appendChild(suggestionItem);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.classList.add('hidden');
            }
        }


        // Async function to fetch media from Google Drive API
        async function fetchMediaFromDriveAPI() {
            homeLoadingMessage.textContent = "Loading media...";
            relatedLoadingMessage.textContent = "Loading related content...";
            console.log('[fetchMediaFromDriveAPI] Attempting to fetch media from Google Drive...');
            console.log(`[fetchMediaFromDriveAPI] FOLDER_ID: ${FOLDER_ID}`);
            console.log(`[fetchMediaFromDriveAPI] API_KEY: ${API_KEY ? 'Provided' : 'Not Provided'}`);


            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+(mimeType+contains+'video'+or+mimeType+contains+'image')&key=${API_KEY}&fields=files(id,name,mimeType,thumbnailLink,webContentLink,createdTime)`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[fetchMediaFromDriveAPI] Failed to fetch from Google Drive API:', response.status, errorText);
                    // Provide a more specific error message to the user
                    let userErrorMessage = 'Unable to load videos/images. ';
                    if (response.status === 403) {
                        userErrorMessage += 'Access denied. Please check your Google Drive API key and folder permissions.';
                    } else if (response.status === 404) {
                        userErrorMessage += 'Folder or files not found. Please check your Google Drive Folder ID.';
                    } else {
                        userErrorMessage += `Error code: ${response.status}`;
                    }
                    homeVideoGrid.innerHTML = `<p class="text-red-400 text-center col-span-full">${userErrorMessage}</p>`;
                    videoList.innerHTML = `<p class="text-red-400 text-center col-span-full">${userErrorMessage}</p>`;
                    throw new Error(`Google Drive API response was not ok: ${response.statusText}. Details: ${errorText}`);
                }
                const data = await response.json();
                console.log('[fetchMediaFromDriveAPI] Google Drive API response received:', data);

                allMediaFiles = []; // Clear previous data

                if (!data.files || !Array.isArray(data.files) || data.files.length === 0) {
                    const noContentMessage = "<p class='col-span-full text-center text-gray-500'>No media found in this folder or access denied.</p>";
                    homeVideoGrid.innerHTML = noContentMessage;
                    videoList.innerHTML = noContentMessage;
                    console.warn('[fetchMediaFromDriveAPI] No files found in Google Drive folder or access denied.');
                    return;
                }

                data.files.forEach(file => {
                    const isVideo = file.mimeType.startsWith('video/');
                    const isImage = file.mimeType.startsWith('image/');

                    if (isVideo || isImage) {
                        allMediaFiles.push({
                            id: file.id,
                            type: isVideo ? 'video' : 'image',
                            title: file.name,
                            url: `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=${API_KEY}`, // Direct media content URL
                            uploadDate: file.createdTime ? new Date(file.createdTime).toISOString().split('T')[0] : 'N/A',
                            thumbnail: file.thumbnailLink || (isVideo ? 'https://placehold.co/320x180/333333/ffffff?text=Video+Thumbnail' : 'https://placehold.co/320x180/333333/ffffff?text=Image+Thumbnail'),
                            mimeType: file.mimeType // Keep mimeType for filtering
                        });
                    }
                });
                console.log(`[fetchMediaFromDriveAPI] Successfully fetched ${allMediaFiles.length} media items.`);

                // Initialize likes and views for newly fetched videos if not already in localStorage
                allMediaFiles.filter(item => item.type === 'video').forEach(video => {
                    if (videoLikes[video.id] === undefined) {
                        videoLikes[video.id] = 0;
                    }
                    if (videoViews[video.id] === undefined) {
                        videoViews[video.id] = 0;
                    }
                });
                saveToLocalStorage(); // Save initial state

                // Render content after data is fetched
                renderHomePageVideos();
                showPage('homePage');

            } catch (error) {
                console.error('[fetchMediaFromDriveAPI] Caught error:', error);
                // The user-facing error message is already set above in the try block
                // if the error was from a non-ok response. If it's another type of error,
                // we'll show a generic message.
                if (!homeVideoGrid.innerHTML.includes('Unable to load videos/images')) {
                    const errorMessage = '<p class="text-red-400 text-center col-span-full">Unable to load videos/images. Please check Google Drive API key, folder ID, or file permissions.</p>';
                    homeVideoGrid.innerHTML = errorMessage;
                    videoList.innerHTML = errorMessage;
                }
            }
        }


        // --- Event Listeners ---

        // Initialize the app on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Assign elements
            homePage = document.getElementById('homePage');
            videoPlayerPage = document.getElementById('videoPlayerPage');
            homeLink = document.getElementById('homeLink');
            searchInput = document.getElementById('searchInput');
            searchResultsContainer = document.getElementById('searchResultsContainer');
            filterButtonsContainer = document.getElementById('filterButtons');

            mainVideoPlayer = document.getElementById('mainVideoPlayer');
            imagePlayer = document.getElementById('imagePlayer');
            mainMediaPlayerContainer = document.getElementById('mainMediaPlayerContainer');
            loadingSpinner = document.getElementById('loadingSpinner');
            playOverlay = document.getElementById('playOverlay');
            controls = document.getElementById('controls');

            playPauseBtn = document.getElementById('playPauseBtn');
            progressBar = document.getElementById('progressBar');
            progressBarFill = document.getElementById('progressBarFill');
            volumeSlider = document.getElementById('volumeSlider');
            muteBtn = document.getElementById('muteBtn');
            currentTimeSpan = document.getElementById('currentTime');
            durationSpan = document.getElementById('duration');
            fullscreenBtn = document.getElementById('fullscreenBtn');

            videoTitle = document.getElementById('videoTitle');
            videoDescription = document.getElementById('videoDescription');
            videoViewsCount = document.getElementById('videoViewsCount');
            videoUploadDate = document.getElementById('videoUploadDate');
            likeButton = document.getElementById('likeButton');
            shareButton = document.getElementById('shareButton');
            downloadButton = document.getElementById('downloadButton');

            videoList = document.getElementById('videoList');
            homeVideoGrid = document.getElementById('homeVideoGrid');
            homeLoadingMessage = document.getElementById('homeLoadingMessage');
            relatedLoadingMessage = document.getElementById('relatedLoadingMessage');

            imageModal = document.getElementById('imageModal');
            modalImage = document.getElementById('modalImage');
            modalCloseButton = document.getElementById('modalCloseButton');


            // Main Player Controls (Video-specific)
            if (playPauseBtn) playPauseBtn.addEventListener('click', togglePlayPause);
            if (playOverlay) playOverlay.addEventListener('click', togglePlayPause);
            if (mainVideoPlayer) mainVideoPlayer.addEventListener('click', togglePlayPause); // Click video to play/pause

            if (mainVideoPlayer) {
                mainVideoPlayer.addEventListener('timeupdate', () => {
                    if (!isDraggingProgressBar) { // Only update if not dragging the slider
                        const progress = (mainVideoPlayer.currentTime / mainVideoPlayer.duration) * 100;
                        progressBar.value = progress;
                        progressBarFill.style.width = `${progress}%`;
                    }
                    currentTimeSpan.textContent = formatTime(mainVideoPlayer.currentTime);
                });

                mainVideoPlayer.addEventListener('loadedmetadata', () => {
                    durationSpan.textContent = formatTime(mainVideoPlayer.duration);
                });

                mainVideoPlayer.addEventListener('ended', () => {
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playOverlay.style.opacity = '1';
                    mainVideoPlayer.currentTime = 0; // Reset to beginning
                    progressBar.value = 0;
                    progressBarFill.style.width = '0%';
                });

                mainVideoPlayer.addEventListener('pause', () => {
                    controls.style.opacity = '1';
                    clearTimeout(controlsTimeout);
                    playOverlay.style.opacity = '1'; // Show overlay when paused
                });
                mainVideoPlayer.addEventListener('play', () => {
                    playOverlay.style.opacity = '0'; // Hide overlay when video starts playing
                    controlsTimeout = setTimeout(() => {
                        controls.style.opacity = '0';
                    }, 3000); // Start timeout to hide controls
                });

                mainVideoPlayer.addEventListener('canplay', () => {
                    loadingSpinner.classList.add('hidden'); // Hide spinner
                });

                mainVideoPlayer.addEventListener('waiting', () => {
                    loadingSpinner.classList.remove('hidden'); // Show spinner when buffering
                });

                mainVideoPlayer.addEventListener('playing', () => {
                    loadingSpinner.classList.add('hidden'); // Hide spinner when playing resumes
                });

                mainVideoPlayer.addEventListener('error', () => {
                    loadingSpinner.classList.add('hidden');
                    playOverlay.style.opacity = '1';
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; // Revert to play icon on error
                    // Display a user-friendly error message on the video player itself
                    videoTitle.textContent = "Error playing media!";
                    videoDescription.textContent = "Could not load the media. Please check your Google Drive API key, folder ID, and ensure the file is publicly accessible.";
                    console.error('[mainVideoPlayer error] An error occurred during video playback. Check media URL and permissions.');
                });
            }


            if (progressBar) {
                progressBar.addEventListener('input', (e) => {
                    const seekTime = (e.target.value / 100) * mainVideoPlayer.duration;
                    mainVideoPlayer.currentTime = seekTime;
                    progressBarFill.style.width = `${e.target.value}%`; // Update fill immediately
                });

                progressBar.addEventListener('mousedown', () => {
                    isDraggingProgressBar = true;
                });
                progressBar.addEventListener('mouseup', () => {
                    isDraggingProgressBar = false;
                });
            }

            if (volumeSlider) {
                volumeSlider.addEventListener('input', (e) => {
                    mainVideoPlayer.volume = e.target.value;
                    updateVolumeIcon();
                });
            }

            if (muteBtn) muteBtn.addEventListener('click', () => {
                if (mainVideoPlayer.volume === 0) {
                    mainVideoPlayer.volume = lastVolume; // Restore last volume
                    volumeSlider.value = lastVolume;
                } else {
                    lastVolume = mainVideoPlayer.volume; // Save current volume
                    mainVideoPlayer.volume = 0;
                    volumeSlider.value = 0;
                }
                updateVolumeIcon();
            });

            if (fullscreenBtn) fullscreenBtn.addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    // Request fullscreen for the media player container
                    if (mainMediaPlayerContainer.requestFullscreen) {
                        mainMediaPlayerContainer.requestFullscreen();
                    } else if (mainMediaPlayerContainer.mozRequestFullScreen) { /* Firefox */
                        mainMediaPlayerContainer.mozRequestFullScreen();
                    } else if (mainMediaPlayerContainer.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                        mainMediaPlayerContainer.webkitRequestFullscreen();
                    } else if (mainMediaPlayerContainer.msRequestFullscreen) { /* IE/Edge */
                        mainMediaPlayerContainer.msRequestFullscreen();
                    }
                }
            });

            document.addEventListener('fullscreenchange', () => {
                if (document.fullscreenElement) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                } else {
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                }
            });

            if (mainMediaPlayerContainer) {
                mainMediaPlayerContainer.addEventListener('mouseenter', () => {
                    if (imagePlayer.classList.contains('hidden')) { // Only show controls if video is active
                        clearTimeout(controlsTimeout);
                        controls.style.opacity = '1';
                    }
                });

                mainMediaPlayerContainer.addEventListener('mouseleave', () => {
                    if (imagePlayer.classList.contains('hidden') && !mainVideoPlayer.paused) { // Only hide if video is playing
                        controlsTimeout = setTimeout(() => {
                            controls.style.opacity = '0';
                        }, 3000); // Hide after 3 seconds of inactivity
                    }
                });
            }

            if (imagePlayer) {
                imagePlayer.addEventListener('load', () => {
                    loadingSpinner.classList.add('hidden'); // Hide spinner
                });

                imagePlayer.addEventListener('error', () => {
                    loadingSpinner.classList.add('hidden');
                    console.error('[imagePlayer error] An error occurred loading the image. Check image URL and permissions.');
                });
            }


            // Event listener for filter buttons
            filterButtonsContainer.addEventListener('click', (event) => {
                const target = event.target;
                if (target.classList.contains('filter-button')) {
                    console.log(`[Filter Button Click] Filter selected: ${target.dataset.filter}`);
                    // Remove active class from all buttons
                    document.querySelectorAll('.filter-button').forEach(button => {
                        button.classList.remove('active');
                    });
                    // Add active class to clicked button
                    target.classList.add('active');
                    currentFilter = target.dataset.filter; // Update current filter
                    renderHomePageVideos(searchInput.value); // Re-render videos with new filter and current search term
                }
            });

            // Search functionality for live suggestions and filtering
            searchInput.addEventListener('input', (event) => {
                const searchTerm = event.target.value;
                console.log(`[Search Input] Current search term: "${searchTerm}"`);
                renderSearchSuggestions(searchTerm);
                // Also filter main grid if on home page
                if (!homePage.classList.contains('hidden')) {
                    renderHomePageVideos(searchTerm);
                }
            });

            // Hide suggestions when search input loses focus, with a small delay
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    searchResultsContainer.classList.add('hidden');
                }, 100); // Small delay to allow click on suggestions to register
            });

            // Show suggestions when search input gains focus if there's text
            searchInput.addEventListener('focus', (event) => {
                const searchTerm = event.target.value;
                if (searchTerm.length > 0) {
                    renderSearchSuggestions(searchTerm);
                }
            });

            // Event listener for MyTube title to go back to home page
            homeLink.addEventListener('click', () => {
                console.log('[Home Link Click] Navigating to home page.');
                showPage('homePage');
                currentFilter = 'all'; // Reset filter to 'all'
                // Reset active button
                document.querySelectorAll('.filter-button').forEach(button => {
                    button.classList.remove('active');
                });
                document.querySelector('.filter-button[data-filter="all"]').classList.add('active');

                renderHomePageVideos(); // Re-render home page videos with 'all' filter
                searchInput.value = ''; // Clear search input
                searchResultsContainer.classList.add('hidden'); // Hide suggestions
            });

            // Event listener for the main player's like button
            likeButton.addEventListener('click', (event) => {
                const mediaId = event.currentTarget.dataset.mediaId;
                handleLikeClick(mediaId);
            });

            // Event listener for the main player's share button
            shareButton.addEventListener('click', handleShareClick);

            // Event listener for the main player's download button
            downloadButton.addEventListener('click', handleDownloadClick);

            // Event listeners for image modal
            modalCloseButton.addEventListener('click', () => {
                imageModal.classList.add('hidden');
            });

            imageModal.addEventListener('click', (event) => {
                // Close modal if clicked outside the image content
                if (event.target === imageModal) {
                    imageModal.classList.add('hidden');
                }
            });

            // Initial load: Fetch videos from Google Drive API
            fetchMediaFromDriveAPI();
            updateVolumeIcon(); // Set initial volume icon
        });
    </script>
</body>
</html>
