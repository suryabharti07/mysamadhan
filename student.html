<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student & Teacher Report Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, professional look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to prevent table from centering vertically */
        }
        .card {
            background-color: white;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 35px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.08);
        }
        .data-table-container {
            max-height: 500px; /* Limit height for vertical scroll */
            overflow-y: auto;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            /* Added styling for ranking table */
            border-bottom: 1px solid #e0e7ff; 
        }
        th {
            position: sticky;
            top: 0;
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            z-index: 10;
        }
        .ranking-row td {
            font-weight: 500;
        }
        .ranking-row:nth-child(1) {
            background-color: #fcd34d; /* Amber-300 for top rank */
            font-weight: bold;
        }
    </style>
</head>
<body class="p-8">

    <div class="w-full max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-3 tracking-tight">ðŸ“š Student and Teacher Report</h1>
            <p class="text-xl text-indigo-700 font-medium">Data Analysis from Two Separate CSV Sources</p>
        </header>

        <!-- Main Report Grid (Summary Cards) - 4 columns on large screens -->
        <div id="report-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
            
            <!-- 1. Student Number Card -->
            <div id="student-card" class="card p-6 text-center border-b-6 border-indigo-500 bg-indigo-50/50">
                <p class="text-xl font-bold text-indigo-500 mb-3">
                    <span id="student-label">Student Number</span>
                </p>
                <div class="text-5xl font-extrabold text-indigo-700" id="total-students">0</div>
                <p class="mt-2 text-xs text-gray-500">Total count of student records.</p>
            </div>

            <!-- 2. Teacher Name Card (Unique Count from Teacher CSV) -->
            <div id="teacher-card" class="card p-6 text-center border-b-6 border-emerald-500 bg-emerald-50/50">
                <p class="text-xl font-bold text-emerald-500 mb-3">
                    <span id="teacher-label">Teacher Name</span>
                </p>
                <div class="text-5xl font-extrabold text-emerald-700" id="total-teachers">0</div>
                <p class="mt-2 text-xs text-gray-500">Count of unique teacher entries.</p>
            </div>

            <!-- 3. Bidupur Students Card -->
            <div id="bidupur-card" class="card p-6 text-center border-b-6 border-yellow-500 bg-yellow-50/50">
                <p class="text-xl font-bold text-yellow-600 mb-3">
                    Bidupur Students
                </p>
                <div class="text-5xl font-extrabold text-yellow-700" id="total-bidupur">0</div>
                <p class="mt-2 text-xs text-gray-500">Total students in Bidupur block.</p>
            </div>

            <!-- 4. Raghopur Students Card -->
            <div id="raghopur-card" class="card p-6 text-center border-b-6 border-red-500 bg-red-50/50">
                <p class="text-xl font-bold text-red-600 mb-3">
                    Raghopur Students
                </p>
                <div class="text-5xl font-extrabold text-red-700" id="total-raghopur">0</div>
                <p class="mt-2 text-xs text-gray-500">Total students in Raghopur block.</p>
            </div>
        </div>

        <!-- Teacher Ranking Table Section (NEW) -->
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Teacher Ranking (Based on Students with > 80% Percent)</h2>
        <div id="teacher-ranking-container" class="data-table-container w-full bg-white">
            <p class="text-center py-12 text-gray-500" id="ranking-loading-message">Calculating teacher rankings...</p>
            <!-- Ranking Table will be injected here -->
        </div>

        <!-- Simple Message Box for Errors/Loading -->
        <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
                <p id="message-text" class="text-xl font-medium text-gray-700">Loading data...</p>
                <div id="spinner" class="mt-4 mx-auto w-6 h-6 border-4 border-indigo-400 border-t-transparent rounded-full animate-spin"></div>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        // CSV Data URLs
        const STUDENT_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT0kegsZDKanviJlh17vG_C5OMY4c0hm6zSvYTQ5GLOUx6k6T4umQogvMxeajAe0HT6wXnOxI5Fa0kT/pub?gid=0&single=true&output=csv';
        const TEACHER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ81zyRqysHzUUvFsYun0Uy31hfszIusdm2L36ClqSpwl-u8mlFd7dt3IRNxPFzE8E8UvVUce8IY2r7/pub?gid=0&single=true&output=csv';

        // Configuration: Column indices (0-based)
        const STUDENT_COLUMN_INDEX = 0; // Column A (Student Name)
        const TEACHER_CSV_INDEX = 0; // Teacher CSV Column 0 (for unique count)
        const TEACHER_NAME_COLUMN_INDEX = 6; // Column G (Teacher Name) in Student CSV
        const PERCENT_COLUMN_INDEX = 7; // Column H (Percent) in Student CSV
        
        // Block Configuration
        const BLOCK_COLUMN_INDEX = 5; // Column F (Block)
        const BIDUPUR_BLOCK_NAME = 'Bidupur';
        const RAGHOPUR_BLOCK_NAME = 'Raghopur';
        const RANKING_THRESHOLD = 80; // Percent threshold for ranking

        // UI elements
        const totalStudentsEl = document.getElementById('total-students');
        const totalTeachersEl = document.getElementById('total-teachers');
        const totalBidupurEl = document.getElementById('total-bidupur');
        const totalRaghopurEl = document.getElementById('total-raghopur');

        const messageBox = document.getElementById('message-box');
        const messageTextEl = document.getElementById('message-text');
        const spinnerEl = document.getElementById('spinner');

        const teacherRankingContainer = document.getElementById('teacher-ranking-container');


        /**
         * Parses CSV text into an array of rows, handling quotes and newlines.
         * @param {string} text The raw CSV data.
         * @returns {string[][]} Array of arrays (rows and columns).
         */
        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const data = [];
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                // Simple split by comma, works for basic CSV structures
                const columns = lines[i].split(',');
                data.push(columns.map(col => col.trim().replace(/^"|"$/g, ''))); // Remove quotes
            }
            return data;
        }

        /**
         * Displays a message box for loading or errors.
         */
        function showMessage(message, isLoading = false) {
            messageTextEl.textContent = message;
            if (isLoading) {
                spinnerEl.classList.remove('hidden');
                messageBox.classList.add('flex');
            } else {
                spinnerEl.classList.add('hidden');
                messageBox.classList.add('flex');
            }
        }

        /**
         * Hides the message box.
         */
        function hideMessage() {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        }

        /**
         * Fetches a CSV file and returns the parsed data.
         * @param {string} url The CSV URL.
         * @returns {Promise<string[][]>} All parsed data (header + records).
         */
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`CSV Fetch Error (Status: ${response.status}) for URL: ${url}`);
            }
            const csvText = await response.text();
            return parseCSV(csvText);
        }

        /**
         * Calculates unique count for a given column in a dataset.
         * @param {string[][]} data The parsed CSV data.
         * @param {number} colIndex The column index for unique counting.
         * @returns {number} The unique count.
         */
        function calculateUniqueCount(data, colIndex) {
            if (data.length <= 1) return 0;
            const records = data.slice(1);
            const uniqueSet = new Set();
            records.forEach(row => {
                const value = row[colIndex];
                if (value && value.trim() !== '') {
                    uniqueSet.add(value.trim().toUpperCase()); 
                }
            });
            return uniqueSet.size;
        }

        /**
         * Generates and displays the Teacher Ranking Table.
         * @param {string[][]} studentData The pre-fetched and parsed Student CSV data.
         */
        function displayTeacherRanking(studentData) {
            const rankingMessageEl = document.getElementById('ranking-loading-message');
            rankingMessageEl.textContent = 'Calculating rankings...';

            try {
                if (studentData.length <= 1) {
                    teacherRankingContainer.innerHTML = '<p class="text-center py-12 text-gray-500">No student data found for ranking.</p>';
                    return;
                }

                const studentRecords = studentData.slice(1);
                const teacherScores = {}; // Key: Teacher Name, Value: Count of > 80% students

                // 1. Calculate scores for each teacher
                studentRecords.forEach(row => {
                    const teacherName = row[TEACHER_NAME_COLUMN_INDEX];
                    const percentValue = parseFloat(row[PERCENT_COLUMN_INDEX]);

                    // Check for valid teacher name and percentage above threshold
                    if (teacherName && teacherName.trim() !== '' && !isNaN(percentValue) && percentValue > RANKING_THRESHOLD) {
                        const name = teacherName.trim();
                        teacherScores[name] = (teacherScores[name] || 0) + 1;
                    }
                });

                // 2. Convert scores to an array and sort it
                let rankingArray = Object.keys(teacherScores).map(name => ({
                    teacherName: name,
                    successfulStudents: teacherScores[name]
                }));

                rankingArray.sort((a, b) => b.successfulStudents - a.successfulStudents);

                if (rankingArray.length === 0) {
                     teacherRankingContainer.innerHTML = `<p class="text-center py-12 text-gray-500">No teachers found whose students scored above ${RANKING_THRESHOLD}%.`;
                     return;
                }

                // 3. Generate Table HTML
                let tableHTML = '<table class="min-w-full divide-y divide-indigo-200 border-collapse">';
                
                // Table Header
                tableHTML += '<thead><tr>';
                tableHTML += '<th class="bg-indigo-600 w-1/12">Rank</th>';
                tableHTML += '<th class="bg-indigo-600 w-6/12">Teacher Name</th>';
                tableHTML += '<th class="bg-indigo-600 w-5/12">Successful Students (> 80%)</th>';
                tableHTML += '</tr></thead>';

                // Table Body
                tableHTML += '<tbody class="bg-white divide-y divide-gray-200">';
                rankingArray.forEach((item, index) => {
                    const rank = index + 1;
                    const rowClass = rank === 1 ? 'ranking-row bg-yellow-100' : 
                                   (rank === 2 ? 'ranking-row bg-gray-100' : 
                                   (rank === 3 ? 'ranking-row bg-amber-100' : 'bg-white hover:bg-indigo-50'));
                    
                    tableHTML += `<tr class="${rowClass} transition duration-150">`;
                    tableHTML += `<td class="text-lg font-extrabold text-center text-indigo-800">${rank}</td>`;
                    tableHTML += `<td class="text-base text-gray-900">${item.teacherName}</td>`;
                    tableHTML += `<td class="text-base text-gray-700 font-bold">${item.successfulStudents}</td>`;
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody></table>';

                teacherRankingContainer.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error generating teacher ranking:', error);
                teacherRankingContainer.innerHTML = `<p class="text-center py-12 text-red-500">Error generating ranking: ${error.message}</p>`;
            }
        }


        /**
         * Fetches data from both CSVs and updates the dashboard.
         */
        async function loadReportData() {
            showMessage('Loading data from both CSVs...', true);

            try {
                // 1. Fetch data concurrently
                const [studentData, teacherData] = await Promise.all([
                    fetchCSV(STUDENT_CSV_URL), 
                    fetchCSV(TEACHER_CSV_URL)   
                ]);
                
                // 2. Process Student Summary Counts
                const studentRecords = studentData.slice(1);
                
                // a. Total Student Number (Count non-empty in STUDENT_COLUMN_INDEX)
                const totalStudentsCount = studentRecords.filter(row => 
                    row[STUDENT_COLUMN_INDEX] && row[STUDENT_COLUMN_INDEX].trim() !== ''
                ).length;

                // b. Block Counts
                let bidupurCount = 0;
                let raghopurCount = 0;
                studentRecords.forEach(row => {
                    const studentName = row[STUDENT_COLUMN_INDEX];
                    const blockName = row[BLOCK_COLUMN_INDEX];
                    
                    // Only count if Student Name is present (valid record)
                    if (studentName && studentName.trim() !== '') {
                        if (blockName && blockName.trim().toUpperCase() === BIDUPUR_BLOCK_NAME.toUpperCase()) {
                            bidupurCount++;
                        }
                        if (blockName && blockName.trim().toUpperCase() === RAGHOPUR_BLOCK_NAME.toUpperCase()) {
                            raghopurCount++;
                        }
                    }
                });

                // c. Total Teacher Unique Count
                const totalTeachersCount = calculateUniqueCount(teacherData, TEACHER_CSV_INDEX);

                // 3. Update Summary UI
                totalStudentsEl.textContent = totalStudentsCount;
                totalTeachersEl.textContent = totalTeachersCount;
                totalBidupurEl.textContent = bidupurCount;
                totalRaghopurEl.textContent = raghopurCount;

                hideMessage(); 

                // 4. Generate and display the Teacher Ranking Table
                displayTeacherRanking(studentData);

            } catch (error) {
                console.error('Error loading report data:', error);
                // Show a generic error message
                showMessage(`Error loading data: ${error.message}. Please ensure both links are in public CSV format.`, false);
                // Reset display
                totalStudentsEl.textContent = 'Error';
                totalTeachersEl.textContent = 'Error';
                totalBidupurEl.textContent = 'Error';
                totalRaghopurEl.textContent = 'Error';
            }
        }

        // Run the function when the window loads
        window.onload = loadReportData;
    </script>

</body>
</html>

