<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samadhan KENDRA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
        }
        .passbook-table-container {
            max-height: 50vh;
            overflow-y: auto;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            animation: slide-up 0.3s ease-out;
            max-height: 100vh;
            overflow-y: auto;
        }
        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* New print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                overflow: visible !important;
                padding: 20px;
                box-sizing: border-box;
            }
            .modal-content {
                animation: none;
                transform: none;
                max-height: none !important;
                overflow: visible !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center justify-start">

    <div class="w-full h-full bg-white rounded-none shadow-none p-6 md:p-10 mt-0 mb-0">
        <h1 class="text-3xl md:text-4xl font-bold mb-2 text-center text-gray-900">SAMADHAN KENDRA</h1>
        <p class="text-sm md:text-base text-center text-gray-600 mb-6">Filter transactions by animator, date and 'Under'.</p>
        
        <!-- Filter Controls -->
        <div class="w-full max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6 px-4 md:px-0">
            <div class="w-full max-w-sm">
                <label for="animatorSelect" class="block text-sm font-medium text-gray-700">Select Animator</label>
                <select id="animatorSelect" class="mt-1 block w-full px-4 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                    <option value="">All Animators</option>
                    <!-- Animators dynamically yahan add honge -->
                </select>
            </div>
            
            <div class="w-full max-w-sm">
                <label for="dateSelect" class="block text-sm font-medium text-gray-700">Collection Date</label>
                <select id="dateSelect" class="mt-1 block w-full px-4 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                    <!-- Dates dynamically yahan add honge -->
                </select>
            </div>

            <div class="w-full max-w-sm">
                <label for="underSelect" class="block text-sm font-medium text-gray-700">Select 'Under'</label>
                <select id="underSelect" class="mt-1 block w-full px-4 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                    <option value="">All 'Under'</option>
                    <!-- Under values dynamically yahan add honge -->
                </select>
            </div>
            
            <div class="flex space-x-2 mt-4 md:mt-0">
                <button id="resetButton" class="w-full md:w-auto px-6 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                    Reset
                </button>
                <button id="generateFinalDataButton" class="w-full md:w-auto px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                    Generate Final Data
                </button>
                <button id="generateListButton" class="w-full md:w-auto px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    LIST
                </button>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="text-center text-gray-500 my-8">
            <div class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p>Loading transactions...</p>
            </div>
        </div>

        <div id="content" class="w-full flex flex-col space-y-8 flex-1 hidden">
            <!-- RECEPT (Sheet 1) Block -->
            <div class="flex-1 bg-white rounded-lg p-6 shadow-md border border-gray-200">
                <h2 class="text-2xl font-bold mb-4 text-green-600 text-center">Receipts</h2>
                <div class="passbook-table-container">
                    <table id="receptTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr></tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Receipts dynamically yahan insert honge -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PAYMENT (Sheet 3) Block -->
            <div class="flex-1 bg-white rounded-lg p-6 shadow-md border border-gray-200">
                <h2 class="text-2xl font-bold mb-4 text-red-600 text-center">Payments</h2>
                <div class="passbook-table-container">
                    <table id="paymentTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr></tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Payments dynamically yahan insert honge -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Final Data Modal -->
    <div id="finalDataModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay p-4">
        <div class="relative w-full h-full bg-white rounded-2xl shadow-2xl p-6 md:p-8 modal-content flex flex-col">
            <button id="closeModalButton" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-center text-gray-900">Final Calculated Data Passbook</h2>
            
            <!-- New Print and Download buttons -->
            <div class="flex justify-center space-x-4 mb-4">
                <button id="printButton" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                    Print
                </button>
                <button id="downloadPdfButton" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                    Download as PDF
                </button>
            </div>

            <div id="finalDataTableContainer" class="flex-1 overflow-y-auto printable-content">
                <!-- Final data yahan render hoga -->
            </div>
        </div>
    </div>
    
    <!-- PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const receptTable = document.getElementById('receptTable');
            const paymentTable = document.getElementById('paymentTable');
            const loadingIndicator = document.getElementById('loading');
            const contentContainer = document.getElementById('content');
            
            const animatorSelect = document.getElementById('animatorSelect');
            const dateSelect = document.getElementById('dateSelect');
            const underSelect = document.getElementById('underSelect');
            
            const resetButton = document.getElementById('resetButton');
            const generateFinalDataButton = document.getElementById('generateFinalDataButton');
            const generateListButton = document.getElementById('generateListButton'); // New button
            const finalDataModal = document.getElementById('finalDataModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const finalDataTableContainer = document.getElementById('finalDataTableContainer');
            const modalTitle = document.getElementById('modalTitle');

            const printButton = document.getElementById('printButton');
            const downloadPdfButton = document.getElementById('downloadPdfButton');


            const headers = {
                recept: ['Animator Name', 'Attend By', 'Under','Meeting Date', 'Collection Date', 'Group Name', 'Field Outstanding', 'Saving Balance', 'Saving', 'Interest', 'Principal', 'Lpf', 'Msc', 'SS', 'Received from others', 'Total'],
                payment: ['Animator Name', 'Attend By', 'Under','Meeting Date', 'Collection Date', 'Group Name', 'Loan Disbursed', 'Paid to Other Staff', 'Bank Deposite Amount (LPF)', 'Bank Deposite Amount (Group A/c)', 'Other Expanse', 'Saving Return', 'Incentive', 'Advance', 'Total']
            };

            const csvUrls = {
                recept: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQrCE9-be3QTYiFHUi2TYLPeNfFCr31DMniWUBWCug9_boA24QvNYNlpwMbiqh8S4PF5gGnXt4riORe/pub?gid=0&single=true&output=csv',
                payment: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQrCE9-be3QTYiFHUi2TYLPeNfFCr31DMniWUBWCug9_boA24QvNYNlpwMbiqh8S4PF5gGnXt4riORe/pub?gid=1342659418&single=true&output=csv'
            };
            
            let allReceptData = [];
            let allPaymentData = [];
            let uniqueDates = [];
            let uniqueAnimators = [];

            /**
             * Fetches and parses a single CSV file from a URL using provided headers.
             * @param {string} url The URL of the CSV file.
             * @param {Array<string>} headers The array of headers to use for parsing.
             * @returns {Promise<Array<Object>>} A promise that resolves with the parsed data.
             */
            async function fetchAndParseCsv(url, headers) {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Failed to fetch CSV:', response.statusText);
                    return [];
                }
                const csvText = await response.text();
                const rawHeaders = csvText.split('\n')[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().replace(/"/g, ''));
                const lines = csvText.split('\n').slice(1).filter(line => line.trim() !== '');
                
                const data = lines.map(line => {
                    const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(val => val.trim().replace(/"/g, ''));
                    const obj = {};
                    rawHeaders.forEach((header, i) => {
                        obj[header] = values[i] || '';
                    });
                    
                    const filteredObj = {};
                    headers.forEach(header => {
                        filteredObj[header] = obj[header] || '';
                    });
                    return filteredObj;
                });
                return data;
            }

            /**
             * Calculates the 'Total' for each receipt row by summing its components.
             * @param {Array<Object>> recepts The receipts data.
             * @returns {Array<Object>>} The updated receipts data with calculated totals.
             */
            function calculateReceptTotals(recepts) {
                const columnsToSum = ['Saving', 'Interest', 'Principal', 'Lpf', 'Msc', 'SS', 'Received from others'];
                return recepts.map(recept => {
                    const total = columnsToSum.reduce((sum, col) => sum + parseFloat(recept[col] || 0), 0);
                    return { ...recept, 'Total': total.toFixed(2) };
                });
            }
            
            /**
             * Populates the date select, animator select, and 'Under' select dropdowns.
             */
            function populateFilters() {
                // Populate Animator Select
                const allAnimators = new Set([...allReceptData.map(item => item['Animator Name']), ...allPaymentData.map(item => item['Animator Name'])]);
                uniqueAnimators = [...allAnimators].filter(Boolean);
                animatorSelect.innerHTML = '<option value="">All Animators</option>' + uniqueAnimators.map(name => `<option value="${name}">${name}</option>`).join('');

                // Populate Date Select
                const allDates = new Set([...allReceptData.map(item => item['Collection Date']), ...allPaymentData.map(item => item['Collection Date'])]);
                uniqueDates = [...allDates].filter(Boolean);
                const today = new Date();
                const todayFormatted = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;

                const sortedDates = uniqueDates.sort((a, b) => {
                    const [d1, m1, y1] = a.split('/').map(Number);
                    const [d2, m2, y2] = b.split('/').map(Number);
                    return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
                });

                dateSelect.innerHTML = `
                    <option value="">All Dates</option>
                    <option value="today">Today (${todayFormatted})</option>
                    ${sortedDates.map(date => `<option value="${date}">${date}</option>`).join('')}
                `;

                // Populate Under Select
                const allUnderValues = new Set([...allReceptData.map(item => item['Under']), ...allPaymentData.map(item => item['Under'])]);
                const uniqueUnderValues = [...allUnderValues].filter(Boolean).sort();
                underSelect.innerHTML = '<option value="">All \'Under\'</option>' + uniqueUnderValues.map(value => `<option value="${value}">${value}</option>`).join('');
            }

            /**
             * Renders a list of items into a specified container with a table format.
             */
            function renderTable(tableElement, items, tableHeaders, type) {
                const theadRow = tableElement.querySelector('thead tr');
                const tbody = tableElement.querySelector('tbody');
                
                theadRow.innerHTML = '';
                tbody.innerHTML = '';
                
                tableHeaders.forEach(header => {
                    const th = document.createElement('th');
                    th.className = 'px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50';
                    th.textContent = header;
                    theadRow.appendChild(th);
                });

                if (items.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="${tableHeaders.length}" class="px-4 py-4 text-sm text-gray-500 text-center">No data found for this selection.</td>`;
                    tbody.appendChild(row);
                    return;
                }

                items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition-colors duration-200';
                    tableHeaders.forEach(header => {
                        const cell = document.createElement('td');
                        cell.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t border-gray-200';
                        cell.textContent = item[header] || 'N/A';
                        if (header === 'Total' || header === 'Previous Cash(Advance)') {
                            const amountColor = type === 'RECEPT' ? 'text-green-600' : 'text-red-600';
                            cell.className += ` font-semibold ${amountColor}`;
                        }
                        row.appendChild(cell);
                    });
                    tbody.appendChild(row);
                });
            }

            /**
             * Applies filters and returns the filtered data.
             */
            function getFilteredData() {
                const selectedAnimator = animatorSelect.value;
                const selectedDateValue = dateSelect.value;
                const selectedUnder = underSelect.value;
                
                let selectedDate = selectedDateValue;

                if (selectedDateValue === 'today') {
                    const today = new Date();
                    selectedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                }
                
                let filteredRecepts = allReceptData;
                let filteredPayments = allPaymentData;

                if (selectedAnimator) {
                    filteredRecepts = filteredRecepts.filter(item => item['Animator Name'] === selectedAnimator);
                    filteredPayments = filteredPayments.filter(item => item['Animator Name'] === selectedAnimator);
                }

                if (selectedDate) {
                    filteredRecepts = filteredRecepts.filter(item => item['Collection Date'] === selectedDate);
                    filteredPayments = filteredPayments.filter(item => item['Collection Date'] === selectedDate);
                }
                
                if (selectedUnder) {
                    filteredRecepts = filteredRecepts.filter(item => item['Under'] === selectedUnder);
                    filteredPayments = filteredPayments.filter(item => item['Under'] === selectedUnder);
                }

                return { filteredRecepts, filteredPayments };
            }
            
            /**
             * Filters the data based on current selections and updates the tables.
             */
            function filterTransactions() {
                const { filteredRecepts, filteredPayments } = getFilteredData();
                renderAllTables(filteredRecepts, filteredPayments);
            }

            /**
             * Renders all tables with the provided data.
             */
            function renderAllTables(recepts, payments) {
                renderTable(receptTable, recepts, headers.recept, 'RECEPT');
                renderTable(paymentTable, payments, headers.payment, 'PAYMENT');
            }

            /**
             * Resets the filters and displays all data.
             */
            function resetFilters() {
                animatorSelect.value = '';
                dateSelect.value = '';
                underSelect.value = '';
                filterTransactions();
            }
            
            /**
             * Finds the previous collection date for a given animator and 'under' value, considering all transactions.
             * @param {string} animator The animator's name.
             * @param {string} under The 'Under' value.
             * @param {string} currentDateStr The current date string in 'DD/MM/YYYY' format.
             * @returns {string|null} The previous date string or null if not found.
             */
            function getPreviousDate(animator, under, currentDateStr) {
                // Combine all data to get all unique dates based on the filters
                let allData = [...allReceptData, ...allPaymentData];
                
                if (animator) {
                    allData = allData.filter(item => item['Animator Name'] === animator);
                }
                if (under) {
                    allData = allData.filter(item => item['Under'] === under);
                }
                
                const uniqueDates = [...new Set(allData.map(item => item['Collection Date']))].filter(Boolean);

                const sortedDates = uniqueDates.sort((a, b) => {
                    const [d1, m1, y1] = a.split('/').map(Number);
                    const [d2, m2, y2] = b.split('/').map(Number);
                    return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
                });
                
                const currentIndex = sortedDates.indexOf(currentDateStr);
                
                if (currentIndex > 0) {
                    return sortedDates[currentIndex - 1];
                }
                
                return null;
            }

            /**
             * Generates the final summary data and displays it in a modal.
             */
            function generateFinalData() {
                const selectedAnimator = animatorSelect.value;
                const selectedDate = dateSelect.value === 'today' ? `${String(new Date().getDate()).padStart(2, '0')}/${String(new Date().getMonth() + 1).padStart(2, '0')}/${new Date().getFullYear()}` : dateSelect.value;
                const selectedUnder = underSelect.value;

                const { filteredRecepts, filteredPayments } = getFilteredData();
                
                let htmlContent = '';
                
                const reportTitle = selectedAnimator ? `Final Data for ${selectedAnimator}` : 'Final Calculated Data (All Animators)';
                modalTitle.textContent = reportTitle;

                // Add animator name and date to the report
                htmlContent += `
                    <div class="mb-4 text-center">
                        <p class="text-lg font-semibold">Animator: ${selectedAnimator || 'All'}</p>
                        <p class="text-lg font-semibold">Collection Date: ${selectedDate || 'All'}</p>
                        ${selectedUnder ? `<p class="text-lg font-semibold">Under: ${selectedUnder}</p>` : ''}
                    </div>
                `;

                // Function to generate a summary table for a given data set and columns
                function createSummaryTable(data, title, columnsToSum) {
                    const summaryData = {};
                    let totalSummarySum = 0;
                    columnsToSum.forEach(col => summaryData[col] = 0);
                    
                    data.forEach(item => {
                        columnsToSum.forEach(col => {
                            const value = parseFloat(item[col] || 0);
                            summaryData[col] += value;
                        });
                    });

                    // Special handling for Receipts Summary and Payments Summary
                    if (title === 'Receipts Summary' || title === 'Payments Summary') {
                        totalSummarySum = columnsToSum.reduce((sum, col) => sum + summaryData[col], 0);
                        summaryData['Total'] = totalSummarySum;
                    }


                    const headersToRender = [...columnsToSum];
                    if (title === 'Receipts Summary' || title === 'Payments Summary') {
                        headersToRender.push('Total');
                    }

                    let tableHtml = `
                        <div class="bg-white rounded-lg p-6 shadow-md border border-gray-200 mt-4">
                            <h3 class="text-xl font-bold mb-2 text-center text-gray-900">${title}</h3>
                            <div class="passbook-table-container">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            ${headersToRender.map(col => `<th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">${col}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            ${headersToRender.map(col => `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 font-semibold">₹${summaryData[col].toFixed(2)}</td>`).join('')}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    return { html: tableHtml, summaryData: summaryData };
                }
                
                const previousDate = getPreviousDate(selectedAnimator, selectedUnder, dateSelect.value);
                const previousAdvanceAmount = previousDate ? allPaymentData
                    .filter(item => {
                        const isAnimatorMatch = !selectedAnimator || item['Animator Name'] === selectedAnimator;
                        const isDateMatch = item['Collection Date'] === previousDate;
                        const isUnderMatch = !selectedUnder || item['Under'] === selectedUnder;
                        return isAnimatorMatch && isDateMatch && isUnderMatch;
                    })
                    .reduce((sum, item) => sum + parseFloat(item['Advance'] || 0), 0)
                    .toFixed(2) : '0.00';
                
                const previousAdvanceNumeric = parseFloat(previousAdvanceAmount);

                const receptSummaryCols = ['Saving', 'Interest', 'Principal', 'Lpf', 'Msc', 'SS', 'Received from others'];
                const { html: receptSummaryHtml, summaryData: receptSummaryData } = createSummaryTable(filteredRecepts, 'Receipts Summary', receptSummaryCols);
                htmlContent += receptSummaryHtml;

                const paymentSummaryCols = ['Loan Disbursed', 'Paid to Other Staff', 'Bank Deposite Amount (LPF)', 'Bank Deposite Amount (Group A/c)', 'Other Expanse', 'Saving Return', 'Incentive', 'Advance'];
                const { html: paymentSummaryHtml, summaryData: paymentSummaryData } = createSummaryTable(filteredPayments, 'Payments Summary', paymentSummaryCols);
                htmlContent += paymentSummaryHtml;
                
                const totalReceiptsSummary = receptSummaryData['Total'] || 0;
                const totalPaymentsSummary = paymentSummaryData['Total'] || 0;
                
                const totalCashReceived = totalReceiptsSummary + previousAdvanceNumeric;
                
                const balance = totalCashReceived - totalPaymentsSummary;
                
                htmlContent += `
                    <div class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg shadow-md flex items-center justify-between">
                        <h3 class="text-xl font-bold text-blue-700">Previous Cash (Advance)</h3>
                        <p class="text-3xl font-extrabold text-blue-600">₹${previousAdvanceAmount}</p>
                    </div>
                `;

                htmlContent += `
                    <div class="mt-4 p-6 bg-green-50 border border-green-200 rounded-lg shadow-md flex items-center justify-between">
                        <h3 class="text-xl font-bold text-green-700">Total Cash Received</h3>
                        <p class="text-3xl font-extrabold text-green-600">₹${totalCashReceived.toFixed(2)}</p>
                    </div>
                `;
                
                htmlContent += `
                    <div class="mt-4 p-6 bg-red-50 border border-red-200 rounded-lg shadow-md flex items-center justify-between">
                        <h3 class="text-xl font-bold text-red-700">Balance</h3>
                        <p class="text-3xl font-extrabold text-red-600">₹${balance.toFixed(2)}</p>
                    </div>
                `;

                finalDataTableContainer.innerHTML = htmlContent;
                showModal();
            }

            /**
             * Generates a detailed list of all transactions for all animators,
             * based on the currently selected filters.
             */
            function generateDetailedList() {
                modalTitle.textContent = 'Filtered Animators Detailed Report';
                let listHtml = '';
                
                const { filteredRecepts, filteredPayments } = getFilteredData();
                const selectedDate = dateSelect.value === 'today' ? `${String(new Date().getDate()).padStart(2, '0')}/${String(new Date().getMonth() + 1).padStart(2, '0')}/${new Date().getFullYear()}` : dateSelect.value;
                const selectedUnder = underSelect.value;

                listHtml += `
                    <div class="mb-4 text-center">
                        <p class="text-lg font-semibold">Collection Date: ${selectedDate || 'All'}</p>
                        ${selectedUnder ? `<p class="text-lg font-semibold">Under: ${selectedUnder}</p>` : ''}
                    </div>
                `;

                // Get unique animators from the filtered data
                const animatorsInList = [...new Set([...filteredRecepts.map(d => d['Animator Name']), ...filteredPayments.map(d => d['Animator Name'])])].filter(Boolean).sort();

                if (animatorsInList.length === 0) {
                     listHtml += `<p class="text-center text-gray-500 text-lg mt-8">No data found for the selected filters.</p>`;
                } else {
                    animatorsInList.forEach(animator => {
                        const animatorRecepts = filteredRecepts.filter(d => d['Animator Name'] === animator);
                        const animatorPayments = filteredPayments.filter(d => d['Animator Name'] === animator);
                        
                        const totalReceipts = animatorRecepts.reduce((sum, item) => sum + parseFloat(item['Total'] || 0), 0);
                        const totalPayments = animatorPayments.reduce((sum, item) => sum + parseFloat(item['Total'] || 0), 0);
                        const balance = totalReceipts - totalPayments;

                        listHtml += `
                            <div class="bg-gray-100 p-4 rounded-md shadow-sm mb-4">
                                <h3 class="text-xl font-bold text-blue-700 mb-2">Animator Name: ${animator}</h3>
                                <div class="flex justify-between items-center mb-4 text-sm font-semibold text-gray-700">
                                    <div>Total Cash Received: <span class="text-green-600">₹${totalReceipts.toFixed(2)}</span></div>
                                    <div>Total Payments: <span class="text-red-600">₹${totalPayments.toFixed(2)}</span></div>
                                    <div>Balance: <span class="${balance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${balance.toFixed(2)}</span></div>
                                </div>
                        `;
                        const receptListHeaders = ['Group Name', 'Meeting Date', 'Saving', 'Interest', 'Principal', 'Lpf', 'Msc', 'SS', 'Received from others', 'Total'];
                        const paymentListHeaders = ['Group Name', 'Meeting Date', 'Loan Disbursed', 'Paid to Other Staff', 'Bank Deposite Amount (LPF)', 'Bank Deposite Amount (Group A/c)', 'Other Expanse', 'Saving Return', 'Incentive', 'Advance', 'Total'];
                        
                        // Receipts Table
                        listHtml += `
                            <div class="mt-2 bg-white p-4 rounded-md shadow-inner border border-gray-200">
                                <h4 class="text-lg font-semibold text-green-600 mb-2">Receipts</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                ${receptListHeaders.map(h => `<th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${animatorRecepts.map(item => `
                                                <tr>
                                                    ${receptListHeaders.map(h => `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t border-gray-200">${item[h] || 'N/A'}</td>`).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;

                        // Payments Table
                        listHtml += `
                            <div class="mt-4 bg-white p-4 rounded-md shadow-inner border border-gray-200">
                                <h4 class="text-lg font-semibold text-red-600 mb-2">Payments</h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                ${paymentListHeaders.map(h => `<th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${animatorPayments.map(item => `
                                                <tr>
                                                    ${paymentListHeaders.map(h => `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 border-t border-gray-200">${item[h] || 'N/A'}</td>`).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;

                        listHtml += `</div>`;
                    });
                }

                finalDataTableContainer.innerHTML = listHtml;
                showModal();
            }

            /**
             * Shows the modal.
             */
            function showModal() {
                finalDataModal.classList.remove('hidden');
            }

            /**
             * Hides the modal.
             */
            function hideModal() {
                finalDataModal.classList.add('hidden');
            }

            /**
             * Initializes the application by fetching all CSV data.
             */
            async function initializeData() {
                loadingIndicator.classList.remove('hidden');
                contentContainer.classList.add('hidden');
                
                try {
                    const [receptData, paymentData] = await Promise.all([
                        fetchAndParseCsv(csvUrls.recept, headers.recept),
                        fetchAndParseCsv(csvUrls.payment, headers.payment)
                    ]);
                    
                    allReceptData = calculateReceptTotals(receptData);
                    allPaymentData = paymentData;

                    populateFilters();
                    renderAllTables(allReceptData, allPaymentData);

                    loadingIndicator.classList.add('hidden');
                    contentContainer.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    loadingIndicator.innerHTML = '<p class="text-red-500">Failed to load data. Please check the URLs.</p>';
                    contentContainer.classList.remove('hidden');
                }
            }

            // Function to handle printing
            function handlePrint() {
                const modalContent = document.getElementById('finalDataModal');
                const originalMaxHeight = modalContent.style.maxHeight;
                const originalOverflow = modalContent.style.overflow;
                
                modalContent.style.maxHeight = 'none';
                modalContent.style.overflow = 'visible';

                window.print();
                
                modalContent.style.maxHeight = originalMaxHeight;
                modalContent.style.overflow = originalOverflow;
            }

            // Function to handle PDF download
            function handleDownloadPdf() {
                const { jsPDF } = window.jspdf;
                const content = document.getElementById('finalDataTableContainer');
                
                const originalMaxHeight = content.style.maxHeight;
                const originalOverflow = content.style.overflow;
                content.style.maxHeight = 'none';
                content.style.overflow = 'visible';
                
                const scale = 2; 

                html2canvas(content, { 
                    scale: scale,
                    windowWidth: document.documentElement.scrollWidth,
                    windowHeight: document.documentElement.scrollHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; 
                    const pageHeight = 297;  
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save('summary-report.pdf');
                }).catch(error => {
                    console.error("Error generating PDF:", error);
                }).finally(() => {
                    content.style.maxHeight = originalMaxHeight;
                    content.style.overflow = originalOverflow;
                });
            }

            // Add event listeners for the filter and new buttons
            animatorSelect.addEventListener('change', filterTransactions);
            dateSelect.addEventListener('change', filterTransactions);
            underSelect.addEventListener('change', filterTransactions);
            resetButton.addEventListener('click', resetFilters);
            generateFinalDataButton.addEventListener('click', generateFinalData);
            generateListButton.addEventListener('click', generateDetailedList); // New event listener for the LIST button
            closeModalButton.addEventListener('click', hideModal);
            finalDataModal.addEventListener('click', (e) => {
                if (e.target.id === 'finalDataModal') {
                    hideModal();
                }
            });

            // Add new event listeners for Print and PDF download
            printButton.addEventListener('click', handlePrint);
            downloadPdfButton.addEventListener('click', handleDownloadPdf);

            // Initial call to load the data when the page loads
            initializeData();
        });
    </script>
</body>
</html>
